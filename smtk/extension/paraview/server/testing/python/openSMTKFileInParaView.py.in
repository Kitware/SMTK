#=============================================================================
#
#  Copyright (c) Kitware, Inc.
#  All rights reserved.
#  See LICENSE.txt for details.
#
#  This software is distributed WITHOUT ANY WARRANTY; without even
#  the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
#  PURPOSE.  See the above copyright notice for more information.
#
#=============================================================================

""" openSMTKFileInParaView.py:

Test the ParaView plugns generated by SMTK for opening .smtk files.

"""

import os
import unittest

import vtk

from paraview import simple as pvsimple

import smtk
import smtk.common
import smtk.testing
from smtk.simple import *


class OpenSMTKFileInParaView(smtk.testing.TestCase):

    def setUp(self):
        pvsimple.LoadPlugin("$<TARGET_FILE:smtkPVServerExtPlugin>", True)
        pvsimple.LoadPlugin("$<TARGET_FILE:smtkRepresentationPlugin>", True)
        pvsimple.LoadPlugin("$<TARGET_FILE:smtkPQComponentsPlugin>", True)
        pvsimple.LoadPlugin("$<TARGET_FILE:smtkPolygonSessionPlugin>", True)

    def testOpenSMTKFile(self):
        pvsimple.OpenDataFile(os.path.join(smtk.testing.DATA_DIR,
                                           'model', '2d', 'smtk', 'epic-trex-drummer.smtk'))
        pvsimple.Show()
        pvsimple.Render()
        self.outFile = os.path.join(smtk.testing.TEMP_DIR, str(smtk.common.UUID.random()) + '.png')
        pvsimple.SaveScreenshot(self.outFile, ImageResolution = (200,200))

        if self.haveVTK() and self.haveVTKExtension():
            import vtk
            self.startRenderTest()
            reader = vtk.vtkPNGReader()
            reader.SetFileName(self.outFile)
            reader.Update()
            self.addImageToScene(reader)
            cam = self.renderer.GetActiveCamera()
            self.renderer.ResetCamera()
            self.renderWindow.Render()
            cmpFile = os.path.join(smtk.testing.DATA_DIR,
                                   'baseline', 'smtk', 'paraview', 'epic-trex-drummer.png')
            smtk.testing.compare_image(self.renderer.GetVTKWindow(), cmpFile)
            if self.interactive():
                self.interact()

    def tearDown(self):
        os.remove(self.outFile)


if __name__ == '__main__':
    smtk.testing.process_arguments()
    unittest.main()
